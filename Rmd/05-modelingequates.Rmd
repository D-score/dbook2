# Modeling equates {#ch:modelingequates}

## GCDG data: design and description

Chapter @ref(#sec:gcdgoverview) provides an overview of the data collected by Global Child Development Group. The group collected item level measurements obatined on 12 instruments for measuring child development across 16 cohorts. 

We coded every items as 0 (fail), 1 (pass) or missing. The Battelle Developmental Inventory scores items as 0 (fail), 1 or 2, depending on the level of skill demonstrated or time taken to complete the task. We joined categories 1 and 2 of these items. The ASQ items were originally scored as 0 (not yet), 5 (sometimes) and 10 (succeeds). We recoded both 5 and 10 to 1. 

We concatenated the datasets from these cohort. The resulting data matrix has 71403 rows (child-visit combinations) and 1572 columns (items) collected from 36345 unique children. We removed 233 items that had fewer than 10 observations in a category. The remaining 1339 items were candidates for analysis. The total number of observed scores was equal to about 2.8 million pass/fail responses. While this is a large number of measurements, about 97 percent of the entries in the matrix is missing.

Subject matter experts classified items into groups of similar appearing items, thus forming 184 equate groups. Each equate group contains at least two items. 

## Modeling strategies

The analytic challenge is twofold:

- to find a subset of items that form a scale;
- to find a subset of equate groups with items similar enough to bridge instruments.

Note that both subsets are related, i.e., changing one affects the other. Thus, we cannot first identify items and then equate groups, or first identify equate groups followed by the items. Rather we need to find the two subsets in an iterative fashion, primarily by hand. This chapter described some of the modelling issues the analyst need to confront.

In general, we look for a final model that

- preserves the items that best fit the Rasch model;
- uses active equate groups with items that behave the same across many cohorts and instruments;
- displays reasonable age-conditional distributions of the D-scores under the model;
- has difficulty estimates that are similar to previous estimates.

The modeling strategy is a delicate balancing act to achieve all of the above objective. Particular actions that we could take to improve a given model are:

- remove bad items;
- inactivate bad equate groups;
- break up bad equate groups;
- move items from one equate group to another;
- create new equate groups;
- remove entire instruments;
- remove persons;
- remove studies.

In order to steer our actions, we look at the following diagnostics (in order of importance): 

- quality of equate group (both visually and through infit);
- plausibility of the distribution of the D-score by age per study;
- correspondence of difficulty estimates from published (single study) Dutch data and the new model;
- infit of the items remaining in the model.

Various routes are possible, and may result different final models. The strategy adopted here is to thicken active equate groups by covering as many studies as possible, in the hope of minimizing the number of active equates needed.

## Empirical and fitted item response curves



## Active and non-active equate groups
```{r plotequates, results = 'hide', fig.keep = 'all', fig.height = 11, warning = FALSE, fig.cap = '(ref:plotequates)', message = FALSE}

pdif <- dmetric::plot_p_d_equate(data = dmetric::gcdg_lean , model = dmetric::model_lean, passive = TRUE)

```
(ref:plotequates) Active and non-active equate groups.


## Splitting and combining equate groups

## Modeling strategies


## Item information

Item information is a psychometric measure the quatifies the utility of the item, given the ability level. So, depending on the person that fills in the item (i.e. the persons ability level), the item provides a certain amount of information to that persons final $D$-score. The item information can be calculated as the conditional probability to endorse an item ($P(\hat\delta_i)$) times the conditional probability to fail an item ($1-P(\hat\delta_i)$). Accordingly, the maximum information an item can provide is when the probability to endorse an item is equal to the probability to fail, i.e. when $P(\hat\delta_i) = 0.5$.

The information is inversely related to the error of measurement, thus more information implies less error of measurement. For each item score in the data, we can compute the amount of information it contributed to the model $D$-score. By summing this information for each item in the model, we can obtain a measure of certainty about the difficulty estimate of the item. This sum of information holds the number of times the item was administered, and the probability of endorsing the item for each assessment. We can grade the items by the information into categories A (best) to D (worst) and visualize how certain we are about the difficuly estimates of the items. In Figure \@ref(fig:iteminfo), the grades are displayed for each item by their difficulty (tau). Most items are graded higher than C, 30 items have an information grade of D and may benefit from more data from future studies. The equate groups are dislayed as black asteriks and mostly have grade A.    

```{r iteminfo, echo = FALSE}
library(dmetric)
library(dinstrument)

itembank <- dscore::builtin_itembank[dscore::builtin_itembank$key == "gcdg",]
#calculate item information given the dscores from gsed 807 model
gcdg_iteminfo <- dmetric::gcdg_lean$itm %>% filter(item %in% itembank$item) %>%
  left_join(dmetric::model_lean$dscore, by = c("subjid", "agedays")) %>%
  left_join(itembank, by = "item") %>% select(subjid, agedays, item, value, cohort, d, tau) %>% mutate(info = dinstrument::info(beta = .data$d, delta = .data$tau)) %>% group_by(item) %>% summarize(n = n(), info = sum(info, na.rm = TRUE), tau = mean(tau)) %>%
  mutate(grade = cut(info, breaks = c(0,5,25,100,10000),
                     labels = c("D", "C", "B", "A")),
         grade = factor(grade, labels = c("D", "C", "B", "A")))

  eqdf <- vector()
 for(i in names(dmetric::model_lean$fit$equate)){
    eqdf1 <- data.frame(equate = i, item = dmetric::model_lean$fit$equate[[i]])
    eqdf <- rbind(eqdf, eqdf1)
  }

gcdg_equateinfo <- 
gcdg_iteminfo %>% filter(item %in% eqdf$item) %>% left_join(eqdf, by = "item") %>%
  group_by(equate) %>%summarize(n = sum(n), info = sum(info, na.rm = TRUE), tau = mean(tau)) %>%
  mutate(grade = cut(info, breaks = c(0,5,25,100,10000),
                     labels = c("D", "C", "B", "A"))) %>%
  arrange(.data$tau)

gcdg_iteminfo <-gcdg_iteminfo %>% filter(!item %in% eqdf$item)



ggplot()+
  geom_point(data = gcdg_iteminfo, aes(x = tau, y = grade, group = grade, color = grade)) +
  geom_point(data = gcdg_equateinfo, aes(x = tau, y = grade, group = grade, color = grade), shape = 8, color = "black", size = 2, stroke = 1.5) +
  theme(legend.position = "none")

```

<!-- Weet even niet zeker of het stukje hieronder erbij moeten doen. Het geeft net wat meer "informatie" over de equate groups, maar het belangrijkste staat eigenlijk al in de plot hierboven.
-->

In our model, equate groups are very important and the selection of the best performing item groups was one of the main modelling steps and an important modeling focus. Hence, the information grade for the equate groups in our model is very high (17 equate groups were graded an A and 1 a B). In Table \@ref(tab:equateinfo) the information for each item is displayed with in the "n" column the number of times the items in the equate groups were administered in the data.    


```{r equateinfo, echo = FALSE}
  eqdf <- vector()
 for(i in names(dmetric::model_lean$fit$equate)){
    eqdf1 <- data.frame(equate = i, item = dmetric::model_lean$fit$equate[[i]])
    eqdf <- rbind(eqdf, eqdf1)
  }

gcdg_equateinfo <- 
gcdg_iteminfo %>% filter(item %in% eqdf$item) %>% left_join(eqdf, by = "item") %>%
  group_by(equate) %>%summarize(n = sum(n), info = sum(info, na.rm = TRUE), tau = mean(tau)) %>%
  mutate(grade = cut(info, breaks = c(0,5,25,100,10000),
                     labels = c("D", "C", "B", "A"))) %>%
  select(equate, tau, n, info, grade) %>%
  arrange(.data$tau) 


knitr::kable(gcdg_equateinfo, 
  caption = "Equate group information in the final model.",
  booktabs = TRUE) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(width = "100%", height = "500px")

```
