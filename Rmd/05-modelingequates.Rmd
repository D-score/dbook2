# Modeling equates {#ch:modelingequates}

## GCDG data: design and description

Chapter @ref(#sec:gcdgoverview) provides an overview of the data collected by Global Child Development Group. The group collected item level measurements obatined on 12 instruments for measuring child development across 16 cohorts. 

We coded every items as 0 (fail), 1 (pass) or missing. The Battelle Developmental Inventory scores items as 0 (fail), 1 or 2, depending on the level of skill demonstrated or time taken to complete the task. We joined categories 1 and 2 of these items. The ASQ items were originally scored as 0 (not yet), 5 (sometimes) and 10 (succeeds). We recoded both 5 and 10 to 1. 

We concatenated the datasets from these cohort. The resulting data matrix has 71403 rows (child-visit combinations) and 1572 columns (items) collected from 36345 unique children. We removed 233 items that had fewer than 10 observations in a category. The remaining 1339 items were candidates for analysis. The total number of observed scores was equal to about 2.8 million pass/fail responses. While this is a large number of measurements, about 97 percent of the entries in the matrix is missing.

Subject matter experts classified items into groups of similar appearing items, thus forming 184 equate groups. Each equate group contains at least two items. 

## Modeling strategies

The analytic challenge is twofold:

- to find a subset of items that form a scale;
- to find a subset of equate groups with items similar enough to bridge instruments.

Note that both subsets are related, i.e., changing one affects the other. Thus, we cannot first identify items and then equate groups, or first identify equate groups followed by the items. Rather we need to find the two subsets in an iterative fashion, primarily by hand. This chapter described some of the modelling issues the analyst need to confront.

In general, we look for a final model that

- preserves the items that best fit the Rasch model;
- uses active equate groups with items that behave the same across many cohorts and instruments;
- displays reasonable age-conditional distributions of the D-scores under the model;
- has difficulty estimates that are similar to previous estimates.

The modeling strategy is a delicate balancing act to achieve all of the above objective. Particular actions that we could take to improve a given model are:

- remove bad items;
- inactivate bad equate groups;
- break up bad equate groups;
- move items from one equate group to another;
- create new equate groups;
- remove entire instruments;
- remove persons;
- remove studies.

In order to steer our actions, we look at the following diagnostics (in order of importance): 

- quality of equate group (both visually and through infit);
- plausibility of the distribution of the D-score by age per study;
- correspondence of difficulty estimates from published (single study) Dutch data and the new model;
- infit of the items remaining in the model.

Various routes are possible, and may result different final models. The strategy adopted here is to thicken active equate groups by covering as many studies as possible, in the hope of minimizing the number of active equates needed.

## Impact of number of active equate groups

```{r model1339, fig.cap = '(ref:model1339)', out.width="760px"}
knitr::include_url(url = "https://stefvanbuuren.name/dbook-apps/models1339", height = "600px")
```
(ref:model1339) D-score by age of four models with all 1339 items using 0, 11, 33 and 184 active equate groups. [ZOOM](https://stefvanbuuren.name/dbook-apps/models1339)

Figure \@ref(fig:model1339) is a display of the D-score by age for all 16 cohorts under four models. As a rough reference to compare, the gray curves in the back represent the Dutch model as calculate from the [SMOCC study](https://stefvanbuuren.name/dbook1/sec-smoccstudy.html). In order to speed up calculation, the figure shows a random subsample of 25\% of all points. Manipulate the plot controls to switch cohorts.

All models contain 1339 items, but differ in the number of active equate groups. The most salient features per model are:

- `1339_0`: No equate groups, so different instruments in different cohorts are fitted independently;
- `1339_11`: Connects all cohorts through one or more equated items using 11 equate groups in total;
- `1339_33`: There are 33 equate groups that bridge cohort and instruments;
- `1339_184`: Maximally connects instruments and cohort by all equate groups.

Comparison of the D-score distibution by age across these models yields various insights:

- The locations of cohorts on the vertical scale depends on the number of active equate groups. For example, for Madagascar (MDG) the points are located around 52 when no equate groups are actived, whereas if all are activated it about 68.

- The age trend depends on the number of active equate groups. For example, for Colombia (COL) or Ethiopia (ETH), the model without equate groups has a shallow age trend, whereas it is steep for the `1339_184` model.

- The vertical spread depends on the number of equate groups. For example, the spread in the Chile-2 (CHL-2) cohort substantially increases with the number of active equates.

- Model `1339_0` for the Dutch NLD-SMOCC cohort is equivalent to the model fitted to the [SMOCC study](https://stefvanbuuren.name/dbook1/sec-smoccstudy.html) alone. Introducing equate groups compresses the range of scores, especially at the higher end.

We have no seen that the number of active equate groups has a large effect on the model. The next sections looks into the equate groups in more detail.

## Percent pass by age

```{r p-a-equate-1339, fig.cap = '(ref:p-a-equate-1339)', out.width="760px"}
knitr::include_url(url = "https://stefvanbuuren.name/dbook-apps/p-a-equate-1339", height = "450px")
```
(ref:p-a-equate-1339) D-score by age of four models with all 1339 items using 0, 11, 33 and 184 active equate groups. [ZOOM](https://stefvanbuuren.name/dbook-apps/p-a-equate-1339)

Figure \@ref(fig:p-a-equate-1339) is a display of the percentage of children that pass a milestone by age, split out according to equate groups. 

## Percent pass by D-score per by equate group

```{r equateconfig, results = "asis"}
df <- data.frame(
  Item = LETTERS[1:6],
  In_model = c(FALSE, TRUE, FALSE, FALSE, TRUE, TRUE),
  Equate = c("", "", "EQ1", "EQ2", "EQ3", "EQ4"),
  Active = c(NA, NA, FALSE, TRUE, FALSE, TRUE),
  Description = c("Not plotted",
                  "Not plotted",
                  "Passive, not plotted",
                  "Not permitted",
                  "Passive, plotted",
                  "Active, plotted")
)

knitr::kable(df, 
  caption = "Plots for equated items for six combinations of items and equate groups.",
  booktabs = TRUE) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(width = "100%")
```
&nbsp;

Table \@ref(tab:equateconfig) lists six possible combinations of items and equate group. An item can be either in or out of the model. The equate group of a given item can be unspecied, passive or active. We create no plots for items that conform to one of the first four combinations. Item D is not permitted, since it is not sensible that an item is part of an active equate group, but not in the model. We routinely change combination D to F by including the item into the model. As an alternative the user may remove the item by hand from the equate group, thereby converting it to type A.

<!-- Since model `1339_0` produces no joint scale across cohort, we will not study it further. At the other extreme, model `1339_184` uses a large number of bridge items, many of which are quite weak, so this model is also not a viable option. The choice is essentially between `1339_11` and `1339_33`. We lean towards pt to continue with `1339_11` for a number of reasons: -->

<!-- - It is better to use a few really good equate groups than a larger number of equate groups of lower quality (INCLUDE REF); -->
<!-- - Model `1339_11` allows for assessment of comparability of more inactive equates; -->
<!-- - Model `1339_11` is closer to model `1339_0`, which increases the likelihood that the D-score scale as developed for the Dutch data will generalise to the other 15 cohorts. -->

<!-- The next step is to select those items that best fit the Rasch model. -->

## Selection of best milestones


## Empirical and fitted item response curves

```{r plotequates, results = 'hide', fig.keep = 'all', fig.height = 11, warning = FALSE, fig.cap = '(ref:plotequates)', message = FALSE}

pdif <- dmetric::plot_p_d_equate(data = dmetric::gcdg_lean , model = dmetric::model_lean, passive = TRUE)

```
(ref:plotequates) Active and non-active equate groups.


## Splitting and combining equate groups

## Modeling strategies


## Item information

Item information is a psychometric measure the quatifies the utility of the item, given the ability level. So, depending on the person that fills in the item (i.e. the persons ability level), the item provides a certain amount of information to that persons final $D$-score. The item information can be calculated as the conditional probability to endorse an item ($P(\hat\delta_i)$) times the conditional probability to fail an item ($1-P(\hat\delta_i)$). Accordingly, the maximum information an item can provide is when the probability to endorse an item is equal to the probability to fail, i.e. when $P(\hat\delta_i) = 0.5$.

The information is inversely related to the error of measurement, thus more information amouts to less error of measurement. For each item score in the data, we can compute the amount of information it contributed to the model $D$-score. By summing this information for each item in the model, we can obtain a measure of certainty about the difficulty estimate of the item. This sum of information holds the number of times the item was administered, and the probability of endorsing the item for each assessment. We can grade the items by the information into categories A (best) to D (worst) and visualize how certain we are about the difficulty estimates of the items. In Figure \@ref(fig:iteminfo), the grades are displayed for each item by their difficulty (tau). Most items are graded higher than C, 30 items have an information grade of D and may benefit from more data from future studies. The equate groups are displayed as black asterisk and mostly have grade A.    

```{r iteminfo, echo = FALSE, warning = FALSE, message = FALSE,fig.cap='(ref:iteminfo)', fig.keep='all',}
library(dmetric)
library(dinstrument)

itembank <- dscore::builtin_itembank[dscore::builtin_itembank$key == "gcdg",]
#calculate item information given the dscores from gsed 807 model
gcdg_iteminfo <- dmetric::gcdg_lean$itm %>% filter(item %in% itembank$item) %>%
  left_join(dmetric::model_lean$dscore, by = c("subjid", "agedays")) %>%
  left_join(itembank, by = "item") %>% select(subjid, agedays, item, value, cohort, d, tau) %>% mutate(info = dinstrument::info(beta = .data$d, delta = .data$tau)) %>% group_by(item) %>% summarize(n = n(), info = sum(info, na.rm = TRUE), tau = mean(tau)) %>%
  mutate(grade = cut(info, breaks = c(0,5,25,100,10000),
                     labels = c("D", "C", "B", "A")),
         grade = factor(grade, labels = c("D", "C", "B", "A")))

  eqdf <- vector()
 for(i in names(dmetric::model_lean$fit$equate)){
    eqdf1 <- data.frame(equate = i, item = dmetric::model_lean$fit$equate[[i]])
    eqdf <- rbind(eqdf, eqdf1)
  }

gcdg_equateinfo <- 
gcdg_iteminfo %>% filter(item %in% eqdf$item) %>% left_join(eqdf, by = "item") %>%
  group_by(equate) %>%summarize(n = sum(n), info = sum(info, na.rm = TRUE), tau = mean(tau)) %>%
  mutate(grade = cut(info, breaks = c(0,5,25,100,10000),
                     labels = c("D", "C", "B", "A"))) %>%
  arrange(.data$tau) %>%
  select(equate, tau, n, info, grade)

gcdg_iteminfo2 <-gcdg_iteminfo %>% filter(!item %in% eqdf$item)




ggplot()+
  geom_point(data = gcdg_iteminfo2, aes(x = tau, y = grade, group = grade, color = grade)) +
  geom_point(data = gcdg_equateinfo, aes(x = tau, y = grade, group = grade, color = grade), shape = 8, color = "black", size = 2, stroke = 1.5) +
  theme(legend.position = "none")

```
(ref:iteminfo) Item information grade by item difficulty (tau) for the final model

<!-- Weet even niet zeker of het stukje hieronder erbij moeten doen. Het geeft net wat meer "informatie" over de equate groups, maar het belangrijkste staat eigenlijk al in de plot hierboven.
-->

In our model, equate groups are very important and the selection of the best performing item groups was one of the main modelling steps and an important modeling focus. Hence, the information grade for the equate groups in our model is very high (17 equate groups were graded an A and 1 a B). In Table \@ref(tab:equateinfo) the information for each item is displayed with in the "n" column the number of times the items in the equate groups were administered in the data.    


```{r equateinfo, echo = FALSE}
knitr::kable(gcdg_equateinfo, 
  caption = "Equate group information in the final model.",
  booktabs = TRUE) %>%
  kableExtra::kable_styling() %>%
  kableExtra::scroll_box(width = "100%", height = "500px")

```
