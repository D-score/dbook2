# Equate groups {#ch:equategroups}

## Definition of equate groups

A group of items that measure the same thing in (perhaps slightly) different
ways is called an “equate group”. An equate group can link items across
instruments by restricting their difficulty estimates to be identical. Equate
groups provide an extra option for bridging different instruments to the same
scale. Figure \@ref(fig:equateex) displays items from three different
instruments that measure child development. The instruments contain some common
items that are measured in multiple instuments, but also unique items. The
common items can be linked in an equate group as displayed by the arrows between
them. In the example there is one (common) item that is equivalent in all three
instruments (i.e. walk alone). The item "sitting" occurs in both the first (i.e.
blue) and the second (i.e. green) instrument and the item "clabs hand together"
occurs in the second (i.e. green) and third (i.e. orange instrument).

```{r equateex, fig.cap = '(ref:equateex)'}
knitr::include_graphics("fig/equate_ex.png")
```
(ref:equateex) Example of three instruments that are bridged by common items in equate groups.

## Concurrent calibration

When each instrument is administered in a different cohort, the cohorts can be
linked by placing the common items in the same column. The common items will
have the same difficulty estimates due to linking with "concurrent calibration".
In concurrent calibration the item parameters for all instruments are estimated
simulateously. Concurrent calibration is an attractive option, thought this
method warrants a strict distinction between items that are truly the same in
different instruments and items that differ. In practice during instrument
development, items measuring the same skill but from different instruments may
have been adapted to suit the format of the instrument (e.g. number of response
options, question formulation, and so on) or the local language and cultural
context, which may or may not have an effect on the measurement properties of
the instrument. This appeals to the possibility to explore and test different
sets of equate items. Also, when in example Figure \@ref(fig:equateex) the first
and second instruments are both administered in the same cohort and the third in
a second, concurrent calibration is not possible for common items in the first
two instruments. In these situations, the equate group method provides a more
flexible way to link items. The equate groups methods works with similar
assumptions as in the concurrent calibration method, but this the flexibility to
explore, test and modify the sets of equate items (i.e. equate groups) used in
the model.



## Requirements of equate groups

Statistical information and subject matter experts form the basis for the
assignment of items to eligible equate groups. In actual modeling, there are
“active” equate groups (i.e. equate groups for which indeed the restriction is
applied) and “passive” equate groups (i.e. similar items for which the
restriction is not applied). Only active groups bridge the different instruments
in the final model.

The following strategies are recommended to be applied to select equate groups:

* As a first step, content experts can start by mapping similar items. For
example use one instrument as a reference and map the items of other instruments
to those items \@ref(sec:mapping).
* In a second step, the mapping can be visualized by plotting the mapped items
in one figure \@ref(sec:viewmapping). That way, potential matches can be
verified and confirmed if they show similar patterns or broken up if they seem
poor matches. In this step, both statistical and content expertise can be
utilized.
* Next, the model can be fitted using a selection of potential matches as active
equate groups. The technical details of this model are explained in
\@ref(sec:statisticalframe). The selection of the final active equate groups for
the model is an iterative process where two important qualifications should be
considered: (1) the active equate groups should link all cohorts and
instruments. (2) To enhance the functioning of equate groups, the active equate
groups are preferably distributed over the scale, rather than centered at one
point.
* The infit and outfit can be calculated for equate groups, which provides a
natural measure of equate group quality \@ref(sec:equatefit).
* The performance of the equategroups across subgroups or cohorts can be tested
with methods designed to detect differential item functioning
\@ref(sec:equatedif).

In general, the use of equate groups is very relevant when the abilities differ
across cohorts. In that case, equate groups are very helpful to place the
abilities across the different cohorts on the same scale. However, when cohort
abilities are relatively uniform and the risk of mis-specification of the equate
groups is high, a model without equate groups would be preferred.


## Statistical framework {#sec:statisticalframe}

The preferred measurement model for development data is the Rasch model. An
introduction of the Rasch model geared towards the $D$-score is described in
https://stefvanbuuren.name/dbook1/. The Rasch model, models the probability of
passing an item as a logistic function of the difference between each person’s
ability and the difficulty of the item, see equation \@ref(eq:rasch).

\begin{equation}
$$\pi_{ni} = \frac{exp(\beta_n - \delta_i)}{1+exp(\beta_n -\delta_i)}$$ (\#eq:rasch)
\end{equation}

Below, the symbols used in the eqation \@ref(eq:rasch) are explained.

Symbol        | Term          | Description
------------- | ------------- | -----------
$\beta_n$     | Ability       | True (but unknown) developmental score of child $n$
$\delta_i$    | Difficulty    | True (but unknown) difficulty of an item $i$
$\pi_{ni}$    | Probability   | Probability that child $n$ passes item $i$

The log odds that a person with ability $\beta_n$ answers an item with
difficulty $\delta_i$ correctly is the difference between the person’s ability
and the item’s difficulty $(\beta_n-\delta_i)$ [@wright1982].

In order to facilitate the use of equate groups to link similar items used in
different instruments and cohorts, the Rasch model can be extended. This
extension holds the restriction that item difficulties of similar items are
constrained to be equal. Wright and Masters [@wright1982] present a simple
method to equate the difficulty between two test forms that have common item
links. This is done by estimating the shift in difficulty as the weighted
average of difficulty differences of the linking items, and using this weighted
average to align the difficulties of the test forms. We can use this way of
aligning forms, to align item difficulties of items in an equate group, see
equation \@ref(eq:raschequate).

\begin{equation}
$$\delta_q = \frac{\sum_{l}^{i} \delta_iw_i}{\sum_{l}^{l} w_i}$$ (\#eq:raschequate)
\end{equation}
 
Where $\delta_q$ is the combined difficulty of the items in the equate group,
$\delta_i$ is the difficulty of each item in the equate group and $l$ is the
number of items in the equate group and $w_i$ is the number of respondents that
have an observed score on item $i$.


## Common latent scale

The end goal for using the equate groups method to model development items is to
measure development on one common latent scale, the $D$-score. That way, the
measure (i.e. D-score) can be obtained, irrespective of which instrument is used
in which population.

As an illustration, the  three example studies from the GCDG
project: the Netherlands 1 study, the Ethiopia study and the Colombia 2 study are used. A
full description of these studies is presented in \@ref(ch:data). Not
all children in these cohorts were administered all items from their respective
instruments and some children were assessed in repeated waves over time. To
obtain a measurement model on the combined data for the three studies, the Rasch
model with equate groups was fitted. Poorly fitting items were removed based on
item infit and outfit (z-score > 0), until the model contained only items with
good fit. In addition, the fit of active equate groups was assessed. Eight
candidate equate groups were carefully selected based on expert judgement as
part of the GCDG project. In total the fitted model contained 185 remaining
items: 31 ASQ items, 84 Bayley-III items, 53 DDI items, and 17 Denver items,
connected by 8 equates. Rasch models with and without equate groups were
fitted with the 185 items.


```{r commonscale, echo=FALSE, fig.cap=, message=FALSE, warning=FALSE}

#nu in gcdg taal (cohort namen - moet dit naar GSED? - staat al in de gecommente stukken.)
##nu gewoon alleen de drie studies uit volledige 565 model gehaald, klopt niet helemaal met de beschrijving hierboven. Dit moet dus nog worden aangepast / beschrijving of model / maar daarvoor moet eerst een strategie bepaald van hoe we modellen opslaan en inladen in dbook2.

library(ddata)
library(dmetric)
library(gseddata)
library(gridExtra)
## model without equate groups
varlist <- prepare_items(study = c("Netherlands 1", "Ethiopia", "Columbia 2"))
model2 <- fit_dmodel(varlist, equate = NULL, name = "noeq",
                        data_package = "ddata", lexicon = "gcdg")

model2$dscore$agedays <- as.integer(model2$dscore$age * 365.25)
model2$dscore$age <- NULL
model2$beta_l$agedays <- as.integer(model2$beta_l$age * 365.25)
model2$beta_l$age <- NULL
model2$items <- rename_gcdg_gsed(model2$items)
model2$itembank$lex_gsed <- rename_gcdg_gsed(model2$itembank$lex_gcdg)
model2$itemtable$item <- rename_gcdg_gsed(model2$itemtable$item)
rownames(model2$fit$item) <- rename_gcdg_gsed(rownames(model2$fit$item))

studies_gcdg <- c("Netherlands 1", "Ethiopia", "Columbia 2")
df1 <- model2$dscore
df1$study <- ifelse(df1$study=="Columbia 2", "Colombia 2", df1$study)
df1$agemos <- df1$agedays/365.25*12
#df1$study <- ifelse(df1$study == "Netherlands 1", "GCDG-NLD-SMOCC", df1$study)
#df1$study <- ifelse(df1$study == "Ethiopia", "GCDG-ETH", df1$study)
#df1$study <- ifelse(df1$study == "Columbia 2", "GCDG-COL-LT45M", df1$study)
#palet <- gseddata::get_palette("study")
palet <- ddata::get_palette("study")
names(palet)[8] <- "Colombia 2"

p1 <- ggplot(df1, aes(agemos, b, group=study, color=study))+
  geom_point()+scale_colour_manual(values = palet, na.value = "grey")+ xlab("Age in Months")+ylab("Ability in logits") +  theme(legend.position =  c(0.8,0.2), legend.title = element_blank())

#model with equate groups
model <- dmetric::model_lean
studies <- c("GCDG-ETH", "GCDG-NLD-SMOCC", "GCDG-COL-LT45M")
df2 <- model$dscore[which(model$dscore$cohort %in% studies),]
df2$cohort <- ifelse(df2$cohort == "GCDG-NLD-SMOCC", "Netherlands 1", df2$cohort)
df2$cohort <- ifelse(df2$cohort == "GCDG-ETH", "Ethiopia", df2$cohort)
df2$cohort <- ifelse(df2$cohort == "GCDG-COL-LT45M", "Colombia 2", df2$cohort)
#palet <- gseddata::get_palette("study")
palet <- ddata::get_palette("study")
names(palet)[8] <- "Colombia 2"

df2$agemos <- df2$agedays/365.25*12
p2 <- ggplot(df2, aes(agemos, b, group=cohort, color=cohort))+
  geom_point()+scale_colour_manual(values = palet, na.value = "grey")+ xlab("Age in Months")+ylab("Ability in logits") +  theme(legend.position =  c(0.8,0.2), legend.title = element_blank())

grid.arrange(p1, p2)


```
(ref:commonscale) Example of three cohorts with and without equage group linking.

Figure \@ref(fig:commonscale) displays the predicted abilities for age for the
model without equate groups (top figure), and the model with equate groups
(bottom figure). In the plot for the model without equate groups it can be
observed that the scales for the Ethiopia and Colombia 2 studies are linked
naturally via the shared items from Bayley-III. The Netherlands 1 cohort is not
connected and follows a different track. In the plot for the model with equate
groups, the scales for all three cohorts are connected, due to the links via
equate groups. This example illustrates that the use of equate groups brings the
abilities for children in different cohorts measured with different instrument
on one scale.



## Quantifying equate fit {#sec:equatefit}

>>explanation of fit measures (briefly) comparable to item fit in dbook1.

## Differential item functioning {#sec:equatedif}

An important assumption underlying equate groups is that the items in the group
work in the same way across the different cohorts, i.e., there is no
differential item functioning. This assumption is critical for active equate
groups. If it is not met, restricting the difficulty parameters to be equal
across cohorts may introduce unwanted bias in comparisons between cohorts.


>>voorbeeld van goede en slechte equate group to show DIF in equate groups.



