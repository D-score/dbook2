```{r ch7libs, include=FALSE}
library(kableExtra)
library(dmetric)
library(gseddata)
library(dplyr)
library(tidyr)
library(ggplot2)
```

# SDG 4.2.1 Indicator {#ch:SDGindicator}

This chapter explains how the $D$-score can be used to indicate on-track
development. The methodology to define on-track development is described and
country-level estimates are displayed. Additionally, the indicator is compared
to other estimates.

* Application I: Estimating the SDG 4.2.1 indicator from existing data
(\@ref(sec:application1))
* Definition *developmentally on track* (\@ref(sec:references))
* Country-level estimates (\@ref(sec:countrytrack))
* Relation to other estimates (\@ref(sec:otherestimates))

## Application I: Estimating the SDG 4.2.1 indicator from existing data {#sec:application1}

Sustainable Development Goal number 4 is to ensure inclusive and equitable
quality education and promote lifelong learning opportunities for all. Target
4.2 is to ensure that by 2030, all girls and boys have access to quality
early childhood development, care and pre-primary education so that they are
ready for primary education. Indicator 4.2.1 is to measure the proportion of
children under 5 years of age who are developmentally on track in health,
learning and psychosocial well-being, by sex.

```{r sdg4, fig.cap = '(ref:sdg4)'}
#knitr::include_graphics("fig/equate_ex.png")
knitr::include_url("https://sustainabledevelopment.un.org/sdg4")
```
(ref:sdg4) Sustainable Development Goal 4.

The $D$-score can be obtained from any instrument that is included in the
calibrations for the score. This makes the $D$-score suited as a global score
for development. Accordingly, the $D$-score can be used for the SDG 4.2.1
indicator and interpreted as the global measure for development.

In the cohorts that are currently included in the GCDG study, a wide range of
countries are represented \@ref(sec:gcdgoverview). Combining existing data from
such a wide range of countries to create the $D$-score, broadens the
interpretation of the $D$-score. Nevertheless, for obtaining accurate references
that represent world-wide population, more representative (existing) data needs
to be added.

## Definition *developmentally on track* {#sec:references}

For child growth, (global) standards are published by the World Health
Organization (WHO) that are used to monitor growth in children and to define
whether children are *on track*. Growth standards are defined for
weight-for-age, length/height-for age, weight-for-length/height, etc. In 2006,
the methods for constructing a growth reference were reviewed by statisticians
and growth experts that resulted in an advised strategy for constructing growth
standard [@borghi2006]. A similar strategy can be used to construct a reference
standard child development-for-age. This reference standard can then be used to
determine whether children are *developmentally on track*.

In Figure \@ref(fig:dscorerefs), the strategy for constructing standards for
development and to use them to define on track development is explained in
several steps. By clicking on the `next` button below the plot, the next test
shows.  In the first step the D-score is plotted by age and in the subsequent
steps, this relation is modeled in an an LMS model. The goal of an LMS model is
to describe the relation of the $D$-score by age with age-conditional z-scores.
This is done by three smoothed curves representing the median, coefficient of
variation and the skewness. The resulting age standardized scores for
development (daz), are then used to define on-track development. So D-scores
within 2 standard deviations from the median can be defined as on-track. Scores
that are more than two standard deviation *below* the median, can be defined as
off-track.


```{r dscorerefs, echo=FALSE, fig.width=10, fig.cap='(ref:dscorerefs)' }
knitr::include_app("https://tnochildhealthstatistics.shinyapps.io/GCDG_references/", 
  height = "700px")
```
(ref:dscorerefs) Method to define on track development

```{r inside shiny references, eval=FALSE, include=FALSE}
##global part:

##CHECK POSSIBILITY TO USE CACHED PLOTS IN ORDER TO LOAD FASTER

#make the GCDG references
library(gseddata)
library(ggplot2)
library(gtools)
library(dbook2tools)
library(shiny)
library(shinyWidgets)
library(shinydashboard)
library(dplyr)
library(tidyr)


theme_set(theme_light())

dscores <- dbook2tools::model_lean$dscore %>%
  mutate(agemos = a * 12, track = ifelse(daz > 2 | daz < (-2), "off", "on")) %>%
  filter(agemos <= 60)

references <- dscore::get_reference("gcdg") %>%
  mutate(month = age * 12) %>%
  select(month, SDM2:SDP2) %>%
  filter(month <= 60) %>%
  pivot_longer(names_to = "centile", values_to = "d", cols = -month)

#make a list of plots, and render the one in the correct step
##step 1: dscores by age geom_point
p_s1 <- ggplot()+
  geom_point(data = dscores, aes(x = agemos, y = d), color = "grey")+
  xlab("Age (months)") + ylab("D-score")+
  ylim(c(0,80)) + xlim(c(0,60))

##step 2: grey geom_point and added median line
p_s2 <- ggplot()+
  geom_point(data = dscores, aes(x = agemos, y = d), color = "grey")+
  xlab("Age (months)") + ylab("D-score")+
  ylim(c(0,80)) + xlim(c(0,60))+
  geom_line(data = subset(references, centile == "SD0"), aes(x = month, y = d), size = 1.1)+
  annotate("label", x = 50, y = 74, label = "median")

##step 3: add the centile distribution
p_s3 <-ggplot()+
  geom_point(data = dscores, aes(x = agemos, y = d), color = "grey")+
  xlab("Age (months)") + ylab("D-score")+
  ylim(c(0,80)) + xlim(c(0,60))+
  geom_line(data = references, aes(x = month, y = d, group = centile), size = 1.1)+
  annotate("label", x = 50, y = 69, label = "-2SD")  +
  annotate("label", x = 50, y = 71.5, label = "-1SD")  +
  annotate("label", x = 50, y = 74, label = "median")  +
  annotate("label", x = 50, y = 76.4, label = "+1SD")  +
  annotate("label", x = 50, y = 78.9, label = "+2SD")

##step 4: plot the z-scores (daz) by age
p_s4 <- ggplot()+
  geom_point(data = dscores, aes(x= agemos, y = daz), color = "grey")+
  geom_abline(aes(intercept = 0, slope = 0), size = 1.1)+
  ylim(c(-4,4))+ xlim(c(0,60))+
  annotate("label", x = 50, y = 0, label = "median")

##step 5: add lines for -/+ 2sd
p_s5 <- ggplot()+
  geom_point(data = dscores, aes(x= agemos, y = daz), color = "grey")+
  geom_abline(aes(intercept = 0, slope = 0), size = 1.1)+
  ylim(c(-4,4))+ xlim(c(0,60))+
  geom_abline(aes(intercept = -2, slope = 0), size = 1.1)+
  geom_abline(aes(intercept = -1, slope = 0), size = 1)+
  geom_abline(aes(intercept = 1, slope = 0), size = 1)+
  geom_abline(aes(intercept = 2, slope = 0), size = 1.1)+
  annotate("label", x = 50, y = -2, label = "-2SD")  +
  annotate("label", x = 50, y = -1, label = "-1SD")  +
  annotate("label", x = 50, y = 0, label = "median")  +
  annotate("label", x = 50, y = 1, label = "+1SD")  +
  annotate("label", x = 50, y = 2, label = "+2SD")

p_s6 <-  ggplot()+
  geom_point(data = dscores, aes(x= agemos, y = daz, group = track, color = track))+
  scale_colour_manual(values = c("red", "grey")) +
  geom_abline(aes(intercept = -2, slope = 0), size = 1.1)+
  geom_abline(aes(intercept = -1, slope = 0), size = 0.9)+
  geom_abline(aes(intercept = 0, slope = 0), size = 1)+
  geom_abline(aes(intercept = 1, slope = 0), size = 0.9)+
  geom_abline(aes(intercept = 2, slope = 0), size = 1.1)+
  theme(legend.position = "none")+
  ylim(c(-4,4))+ xlim(c(0,60))+
  annotate("label", x = 50, y = -2, label = "-2SD")  +
  annotate("label", x = 50, y = -1, label = "-1SD")  +
  annotate("label", x = 50, y = 0, label = "median")  +
  annotate("label", x = 50, y = 1, label = "+1SD")  +
  annotate("label", x = 50, y = 2, label = "+2SD")




plot_list <- list(p_s1, p_s2, p_s3, p_s4, p_s5, p_s6)


txt_p1 <- ("<b>Step 1:</b> plot the D-scores by age.")
txt_p2 <- ("<b>Step 2:</b> fit a smooth curve for the median relation between age and development (D-score)")
txt_p3 <- ("<b>Step 3:</b> estimate the variation and skewness and draw standard deviation lines")
txt_p4 <- ("<b>Step 4:</b> tranform the D-score to z-scores (daz)")
txt_p5 <- ("<b>Step 5:</b> mark the standard deviation lines in daz")
txt_p6 <- ("<b>Step 6:</b> observations that are more than 2 standard deviations away from the mean are off-track.")
steps_list <- list(txt_p1,txt_p2,txt_p3,txt_p4,txt_p5,txt_p6)

#SERVER
  steps <- reactiveVal(1)

  observeEvent(input$run1, {
    old_count = steps()
    if(old_count < 6){
    steps(old_count + 1)}
  })
  observeEvent(input$prev1, {
    old_count = steps()
    if(old_count > 1){
      steps(old_count - 1)}
  })


##UI
   fluidRow(box(width = 1100,
        column(1, offset = 1, actionButton("prev1", "Prev")),
        column(1, offset = 8, actionButton("run1", "Next"))
   ))
   fluidRow(width = 1000,
    column(12, offset = 1,
    renderUI(
    HTML(print(steps_list[[steps()]]))
    )))
   box(
     renderPlot({
         plot_list[[steps()]]
  }),height = 500, width = 1000
    )



```


Note that the current reference is based on the GCDG study. The cohorts that are
currently included are representing a wide range of countries. However, they are
not representative for a global population. The current reference standards are
therefore temporary and should be improved when more data are available.


## Country-level estimates {#sec:countrytrack}

For each age-$D$-score combination, a daz can be calculated. That way we can
calculate the daz in each country that is included in the current GCDG study. By
using the -2SD rule, we can obtain the percentage on-track development in each
country.

```{r, echo = FALSE}
tabtrack <- model_lean$dscore %>%
  mutate(track = ifelse(daz < -2, 0, 1),
         country =  substr(cohort, 6, 8) ) %>%
  group_by(country) %>%
  summarize("on-track"= sum(track, na.rm=TRUE)/sum(!is.na(track)))

kable(tabtrack,
      caption = "Percentage of on-track children per country",
      digits = 2)

```
&nbsp;

## Relation to other estimates {#sec:otherestimates}

In the publication on the $D$-score from the GCDG project [@Weber2019], the concurrent, discriminant and predictive validity of the $D$-score is thorougly presented and discussed. In this paragraph we mainly focus on stunting, which commonly used to express impaired growth in children due to nutrition problems. 

### Stunting

The WHO defines stunted as [when the height-for-age is more than two standard deviations below
the WHO Child Growth Standard median](https://www.who.int/nutrition/healthygrowthproj/en/index1.html). In Figure \@ref(fig:stunt) we compare the percentage stunted to the percentage off-track
development in each country. The percentages of stunting differ a lot from the off-track developmental percentages. This indicates that "growth" and "development" are very different construct. 

```{r stunt, echo=FALSE, fig.cap='(ref:stunt)'}

##change to mean D-score in stunted vs non-stunted children (ref to paper Weber et.al.) But then this plot after that?
#or just load gcdg_lean form dmetric when data in package is updated
sdg_stunt <- 
dmetric::gcdg_lean$visit %>% 
  left_join(dmetric::model_lean$dscore) %>%
  mutate(track = ifelse(.data$daz < -2, 0, 1),
         stunting = ifelse(.data$haz < -2, 1, 0)) %>%
  group_by(ctrycd) %>%
  summarize("off-track" = 1-sum(track, na.rm=TRUE)/sum(!is.na(track)),
            "n_d" = sum(!is.na(track)),
            "stunted" = sum(stunting, na.rm=TRUE)/sum(!is.na(stunting)), 
            "n_stunt" = sum(!is.na(stunting))) %>%
  pivot_longer(cols = c("off-track", "stunted"), names_to = "Measure", values_to = "Percentage")


ggplot(data = sdg_stunt, aes(x = ctrycd, y = Percentage, fill = Measure)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  xlab("Country")


# hazdaz <- dmetric::gcdg_lean$visit %>% 
#   left_join(dmetric::model_lean$dscore) %>%
#   mutate(track = ifelse(.data$daz < -2, 0, 1),
#          stunting = ifelse(.data$haz < -2, 1, 0))%>%
#   group_by(ctrycd) %>%
#   summarize(haz = mean(haz, na.rm = TRUE),
#             daz = mean(daz, na.rm = TRUE),
#             track = mean(track, na.rm = TRUE),
#             stunt = mean(stunting, na.rm = TRUE))
# 
# 
# ggplot(data = hazdaz, aes(x = haz, y = daz, color = ctrycd)) +
#   geom_point() +
#   coord_equal()
# 
# ggplot(data = hazdaz, aes(x = haz, y = daz)) +
#   geom_point() + xlim(-2,2) + ylim(-2,2)+
#   coord_equal()


```
(ref:stunt) Percentage off-track development and stunted per country


However, we can see a relation between stunting and development ($D$-score). When we compare the Standardized $D$-score (DAZ) in each country for the stunted versus not-stunted children (Figure \@ref(fig:stuntdaz))

```{r stuntdaz, echo=FALSE, fig.width=11, fig.cap= '(ref:stuntdaz)'}
##DAZ in stunted vs non-stunted (as done in Weber paper)
sdg_stuntdaz <- 
dmetric::gcdg_lean$visit %>% 
  left_join(dmetric::model_lean$dscore) %>%
  mutate(stunting = ifelse(.data$haz < -2, "stunted", "not-stunted")) %>%
  group_by(ctrycd, stunting) %>%
  summarize("DAZ" =  mean(daz, na.rm = TRUE)) %>%
  drop_na()

ggplot(sdg_stuntdaz, aes(x = ctrycd, y = DAZ, fill = stunting))+
  geom_bar(stat = "identity", position = "dodge")
```
(ref:stuntdaz) DAZ for stunted versus not-stunted per country


<!--# To validate the off-track development measured by the $D$-score we can compare the percentage off-track in the studies that administered the `by2` or `by3` using the cut-off for developmental delay (i.e. <70 for `by2`and <78 for `by3` [@https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5940608/]). 
-->


```{r eval=FALSE, include=FALSE}
##cohorts with by3
##cohort with by2
##does not work yet!!!!
#note 14/4/2020: the Bayley scores (and other) are obtianed via study owners and are not part of the data. So we only have the (standardized) scores per cohort, but not specifically related to sdg(off-track). New idea: relate ontrack vs offtrack to the standardized scores per cohort. Hypothesis: when more off-track - lower standardized scores... >>>>> later uitvoeren (staat er nu nog niet in). Eerst even op ch8 richten. 

#join based on subjido & cohort/study. So translate study in ddata gcdg data to cohort in GSEDDATA.
library(dmetric)
library(ddata)
library(dscore)
library(dplyr)
library(tidyr)
library(ggplot2)


gsed_cohort <- unique(dmetric::model_lean$dscore$cohort)
gcdg_aux <- ddata::get_gcdg(items = FALSE, adm=TRUE, aux = TRUE, cov = TRUE)
gcdg_study <- unique(gcdg_aux$study) #brazil2 not in model?

cohort_study <- data.frame(gsed_cohort = gsed_cohort, gcdg_study = gcdg_study[c(4,6,9,10,13,
                                                                                1,5,16,7,8,
                                                                                2,14,15,11,12)])


 gcdg_d_aux <- gcdg_aux %>%
            mutate(subjido = as.character(id), 
                   cohort = cohort_study[match(gcdg_aux$study, cohort_study[,"gcdg_study"]), "gsed_cohort"], 
                   b_total = rowSums(select(.,b_tot_cog, b_tot_lr, b_tot_le, b_tot_mf, b_tot_mg), na.rm =TRUE)) %>% left_join(dmetric::model_lean$dscore, by = c("subjido", "cohort"))
 
 gcdg_d_aux %>% group_by(cohort) %>%
   summarize(cog = mean(b_pc_cog, na.rm=TRUE),
             lang = mean(b_pc_lang, na.rm=TRUE),
             mot = mean(b_pc_mot, na.rm=TRUE),
             fm = mean(b_tot_mf, na.rm=TRUE),
             gm = mean(b_tot_mg, na.rm=TRUE),
             asq_cog = mean(asq_cog, na.rm =TRUE),
             den_mf = mean(den_mf, na.rm = TRUE))
 
 by_track <- gcdg_d_aux %>%
   mutate(track = ifelse(.data$daz < -2, 0, 1), 
          by_d = ifelse(.data$b_total < 70, 1, 0)) %>%
 group_by(country) %>%
  summarize("off-track" = 1-sum(track, na.rm=TRUE)/sum(!is.na(track)),
            "n_d" = sum(!is.na(track)),
            "b_delay" = sum(by_d, na.rm=TRUE)/sum(!is.na(by_d)), 
            "n_b" = sum(!is.na(by_d))) %>%
  pivot_longer(cols = c("off-track", "b_delay"), names_to = "Measure", values_to = "Percentage")


ggplot(data = by_track, aes(x = country, y = Percentage, fill = Measure)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  xlab("Country")

 

 ##vanaf hier verder gaan bij vergeliking met totaal scores op andere measures. 
 
 ##verder deze data gebruiken voor CH8.
 
#select by3 cohorts
by3_COH <- c("GCDG-CHN", "GCDG-COL-LT42M", "GCDG-COL-LT45M", "GCDG-ETH")
#calculate mean of "b_tot_cog"     "b_tot_lr"      "b_tot_le"      "b_tot_mf"      "b_tot_mg"  for bayley total score. 
# add score to dscore data (and visit data for stunting)
#cut score at 70 (or 78) for bayley delay score.

b_vars <- c("b_tot_cog","b_tot_lr","b_tot_le","b_tot_mf","b_tot_mg")

b_scores <- gcdg_lean$aux %>% filter(variable %in% b_vars) %>%
  group_by(subjid)%>% summarize(b_score = mean(value, na.rm=TRUE))



sdg_by <- 
gcdg_lean$visit %>% filter(cohort %in% by3_COH) %>%
  left_join(b_scores) %>%
  left_join(model_lean$dscore) %>%
  mutate(track = ifelse(.data$daz < -2, 0, 1),
                  stunting = ifelse(.data$haz < -2, 1, 0),
         by_d = ifelse(.data$b_score < 70, 1, 0)) %>%
  group_by(ctrycd) %>%
  summarize("off-track" = 1-sum(track, na.rm=TRUE)/sum(!is.na(track)),
            "n_d" = sum(!is.na(track)),
            "stunted" = sum(stunting, na.rm=TRUE)/sum(!is.na(stunting)), 
            "n_stunt" = sum(!is.na(stunting)),
            "b_delay" = sum(by_d, na.rm = TRUE)/sum(!is.na(by_d))) %>%
  pivot_longer(cols = c("off-track", "stunted"), names_to = "Measure", values_to = "Percentage")


ggplot(data = sdg_stunt, aes(x = ctrycd, y = Percentage, fill = Measure)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  xlab("Country")
```