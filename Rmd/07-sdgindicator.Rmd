```{r ch7libs, include=FALSE}
library(kableExtra)
library(dmetric)
library(gseddata)
library(dplyr)
library(tidyr)
library(ggplot2)
```

# Application I: Tracking a Sustainable Development Goal {#ch:SDGindicator}

> Author: Iris Eekhout

The Sustainable Development Goals (SDG) formulated by the United Nations (UN) set targets to promote prosperity while protecting the planet. One or more indicators quantify the progress towards each target. 

This chapter explores the use of the D-score to monitor the progress of the indicator for healthy child development, SDG 4.2.1. We propose a method to define on-track development and show how the application of this method pans out for the GCDG data. More in detail, the chapter deals with the following topics:

* Estimating SDG 4.2.1 indicator from existing data (\@ref(sec:application1))
* Definition *developmentally on track* (\@ref(sec:references))
* Country-level estimates (\@ref(sec:countrytrack))
* Relation to other estimates (\@ref(sec:otherestimates))

## Estimating SDG 4.2.1 indicator from existing data {#sec:application1}

The [UN Sustainable Development Goals](https://www.un.org/sustainabledevelopment/development-agenda/) form a universal call to action to end poverty, protect the planet and improve the lives and prospects of everyone, everywhere. All UN Member States adopted the 17 Goals in 2015. The SDG 4 target to ensure inclusive and equitable quality education and promote lifelong learning opportunities for all. SDG 4.2 reads as:

> By 2030, ensure that all girls and boys have access to quality early childhood development, care and preprimary education so that they are ready for primary education.

To measure progress, the UN defined indicator 4.2.1 as follows: 

> Proportion of children under 5 years of age who are developmentally on track in health, learning and psychosocial well-being, by sex.

On July 22, 2020, the indicator was [changed](https://unstats.un.org/sdgs/metadata/) into 

> Proportion of children aged 24-59 months who are developmentally on track in health, learning and psychosocial well-being, by sex.

The exclusion of children 0-24 months is at variance with the importance of healthy growth and development during the first 1000 days of life. Indeed, the UN restricted the age range for practical concerns. @loizillon2017 report:

> The initial recommendation was for the ECDI to measure child development from birth–5 years, but the range was restricted to 3–5 years due to time and resource constraints and limited availability of comparable measurement tools for children under age 3.

The careful scientific approach underlying the D-score fills the gap for children aged 0-24 months. Also, the D-score methodology enables extensions to ages beyond 24 months, permits back-calculation of D-scores from existing data, and acts as a linking pin to compare child development from birth onwards.

The cohorts included in the GCDG study represent a wide range of countries and instruments (see Section \@ref(sec:gcdgoverview)). Combining existing data from such a wide range of countries to create the D-score, is undoubtedly challenging, but doable. Although, in all fairness, we note that obtaining accurate comparisons between world-wide populations requires additional representative (existing) data beyond what is available here.

## Definition *developmentally on track* {#sec:references}

In 2006, the World Health Organisation (WHO) published the [WHO Child Growth Standards](https://www.who.int/childgrowth/publications/technical_report_pub/en/). These standards specify "how children should grow" and form the basis for widely used anthropometric indicators such as stunting and wasting. We advocate a similar approach for child development. More in particular, the would consist of the following steps:

1. Measure child development on an interval scale;
2. Estimate the age-conditional reference distribution for normal child development;
3. Define the indicator *developmentally on track* as the proportion above a chosen cut-off. 

Step 1 is solved by the D-score. Step 2 borrows from well-tested statistical methodology for constructing growth standard [@borghi2006]. Step 3 can be done in different ways, but a applying a simple cut-off fits easily with regular practice in reporting international comparisons.

```{r dscorerefs, echo=FALSE, out.width="760px", fig.cap='(ref:dscorerefs)' }
#knitr::include_app("https://tnochildhealthstatistics.shinyapps.io/GCDG_references/", 
#  height = "700px")
knitr::include_url("https://iriseekhout.github.io/dbook2tools/gcdgreferences/",
                   height = "800px")
```
(ref:dscorerefs) Illustration of the method to define on-track development

Figure \@ref(fig:dscorerefs) demonstrates steps 2 and 3 in more detail. Click 'Next' to advance a series of six steps:

1. Plot the D-score by age;
2. Model the relation between age and D-score by an LMS model. In practice, this amounts to smoothing three curves representing the median, coefficient of variation
and the skewness. 
3. Present the centile lines for the model; 
4. Plot the age-standardized scores for development (DAZ);
5. Draw standard deviation lines to indicate the location at $\pm$ 1 and $\pm$ 2 standard deviation from the mean;
6. Count observations above the -2 SD line as on-track. Count observation below the -2 SD lines as off-track (red dots).

*Note: These SD lines build upon on a convenience sample. The GCDG cohorts are not representative samples, and the countries are not representative of the world. While we should not over-interpret these references, they play a central role in a stepwise, principled approach to define "developmentally on track".*

## Country-level estimates {#sec:countrytrack}

For each age-D-score combination, a standardized score (DAZ) can be calculated. That way we can
calculate the DAZ in each country that is included in the current GCDG study. By
using the -2SD rule, we can obtain the percentage on-track development for each
country.

```{r, echo = FALSE}
tabtrack <- model_lean$dscore %>%
  mutate(track = ifelse(daz < -2, 0, 1),
         country =  substr(cohort, 6, 8) ) %>%
  group_by(country) %>%
  summarize("on-track"= sum(track, na.rm=TRUE)/sum(!is.na(track)))

kable(tabtrack,
      caption = "Percentage of on-track children per country",
      digits = 2)

```
&nbsp;

## Relation to other estimates {#sec:otherestimates}

In the publication on the global D-score from the GCDG project [@Weber2019], the concurrent, discriminant and predictive validity of the D-score is thoroughly presented and discussed. In this paragraph we mainly focus on stunting, which is commonly used to express impaired growth in children due to nutrition problems. 

### Stunting

The WHO defines stunted as [when the height-for-age is more than two standard deviations below
the WHO Child Growth Standard median](https://www.who.int/nutrition/healthygrowthproj/en/index1.html). In Figure \@ref(fig:stunt) we compare the percentage stunted to the percentage off-track
development in each country. The percentages of stunting differ a lot from the off-track developmental percentages. This indicates that "growth" and "development" are very different constructs. 

```{r stunt, echo=FALSE, fig.cap='(ref:stunt)'}

##change to mean D-score in stunted vs non-stunted children (ref to paper Weber et.al.) But then this plot after that?
#or just load gcdg_lean form dmetric when data in package is updated
sdg_stunt <- 
dmetric::gcdg_lean$visit %>% 
  left_join(dmetric::model_lean$dscore) %>%
  mutate(track = ifelse(.data$daz < -2, 0, 1),
         stunting = ifelse(.data$haz < -2, 1, 0)) %>%
  group_by(ctrycd) %>%
  summarize("off-track" = 1-sum(track, na.rm=TRUE)/sum(!is.na(track)),
            "n_d" = sum(!is.na(track)),
            "stunted" = sum(stunting, na.rm=TRUE)/sum(!is.na(stunting)), 
            "n_stunt" = sum(!is.na(stunting))) %>%
  pivot_longer(cols = c("off-track", "stunted"), names_to = "Measure", values_to = "Percentage")


ggplot(data = sdg_stunt, aes(x = ctrycd, y = Percentage, fill = Measure)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  xlab("Country")


# hazdaz <- dmetric::gcdg_lean$visit %>% 
#   left_join(dmetric::model_lean$dscore) %>%
#   mutate(track = ifelse(.data$daz < -2, 0, 1),
#          stunting = ifelse(.data$haz < -2, 1, 0))%>%
#   group_by(ctrycd) %>%
#   summarize(haz = mean(haz, na.rm = TRUE),
#             daz = mean(daz, na.rm = TRUE),
#             track = mean(track, na.rm = TRUE),
#             stunt = mean(stunting, na.rm = TRUE))
# 
# 
# ggplot(data = hazdaz, aes(x = haz, y = daz, color = ctrycd)) +
#   geom_point() +
#   coord_equal()
# 
# ggplot(data = hazdaz, aes(x = haz, y = daz)) +
#   geom_point() + xlim(-2,2) + ylim(-2,2)+
#   coord_equal()


```
(ref:stunt) Percentage off-track development and stunted per country


However, we can see a relation between stunting and development (D-score). When we compare the Standardized D-score (DAZ) in each country for the stunted versus not-stunted children (Figure \@ref(fig:stuntdaz)). The DAZ for the stunted children is always lower in comparison with the not-stunted children.

```{r stuntdaz, echo=FALSE, fig.width=11, fig.cap= '(ref:stuntdaz)'}
##DAZ in stunted vs non-stunted (as done in Weber paper)
sdg_stuntdaz <- 
dmetric::gcdg_lean$visit %>% 
  left_join(dmetric::model_lean$dscore) %>%
  mutate(stunting = ifelse(.data$haz < -2, "stunted", "not-stunted")) %>%
  group_by(ctrycd, stunting) %>%
  summarize("DAZ" =  mean(daz, na.rm = TRUE)) %>%
  drop_na()

ggplot(sdg_stuntdaz, aes(x = ctrycd, y = DAZ, fill = stunting))+
  geom_bar(stat = "identity", position = "dodge")
```
(ref:stuntdaz) DAZ for stunted versus not-stunted per country


<!--# To validate the off-track development measured by the D-score we can compare the percentage off-track in the studies that administered the `by2` or `by3` using the cut-off for developmental delay (i.e. <70 for `by2`and <78 for `by3` [@https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5940608/]). 
-->


```{r eval=FALSE, include=FALSE}
##cohorts with by3
##cohort with by2
##does not work yet!!!!
#note 14/4/2020: the Bayley scores (and other) are obtianed via study owners and are not part of the data. So we only have the (standardized) scores per cohort, but not specifically related to sdg(off-track). New idea: relate ontrack vs offtrack to the standardized scores per cohort. Hypothesis: when more off-track - lower standardized scores... >>>>> later uitvoeren (staat er nu nog niet in). Eerst even op ch8 richten. 

#join based on subjido & cohort/study. So translate study in ddata gcdg data to cohort in GSEDDATA.
library(dmetric)
library(ddata)
library(dscore)
library(dplyr)
library(tidyr)
library(ggplot2)


gsed_cohort <- unique(dmetric::model_lean$dscore$cohort)
gcdg_aux <- ddata::get_gcdg(items = FALSE, adm=TRUE, aux = TRUE, cov = TRUE)
gcdg_study <- unique(gcdg_aux$study) #brazil2 not in model?

cohort_study <- data.frame(gsed_cohort = gsed_cohort, gcdg_study = gcdg_study[c(4,6,9,10,13,
                                                                                1,5,16,7,8,
                                                                                2,14,15,11,12)])


 gcdg_d_aux <- gcdg_aux %>%
            mutate(subjido = as.character(id), 
                   cohort = cohort_study[match(gcdg_aux$study, cohort_study[,"gcdg_study"]), "gsed_cohort"], 
                   b_total = rowSums(select(.,b_tot_cog, b_tot_lr, b_tot_le, b_tot_mf, b_tot_mg), na.rm =TRUE)) %>% left_join(dmetric::model_lean$dscore, by = c("subjido", "cohort"))
 
 gcdg_d_aux %>% group_by(cohort) %>%
   summarize(cog = mean(b_pc_cog, na.rm=TRUE),
             lang = mean(b_pc_lang, na.rm=TRUE),
             mot = mean(b_pc_mot, na.rm=TRUE),
             fm = mean(b_tot_mf, na.rm=TRUE),
             gm = mean(b_tot_mg, na.rm=TRUE),
             asq_cog = mean(asq_cog, na.rm =TRUE),
             den_mf = mean(den_mf, na.rm = TRUE))
 
 by_track <- gcdg_d_aux %>%
   mutate(track = ifelse(.data$daz < -2, 0, 1), 
          by_d = ifelse(.data$b_total < 70, 1, 0)) %>%
 group_by(country) %>%
  summarize("off-track" = 1-sum(track, na.rm=TRUE)/sum(!is.na(track)),
            "n_d" = sum(!is.na(track)),
            "b_delay" = sum(by_d, na.rm=TRUE)/sum(!is.na(by_d)), 
            "n_b" = sum(!is.na(by_d))) %>%
  pivot_longer(cols = c("off-track", "b_delay"), names_to = "Measure", values_to = "Percentage")


ggplot(data = by_track, aes(x = country, y = Percentage, fill = Measure)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  xlab("Country")

 

 ##vanaf hier verder gaan bij vergeliking met totaal scores op andere measures. 
 
 ##verder deze data gebruiken voor CH8.
 
#select by3 cohorts
by3_COH <- c("GCDG-CHN", "GCDG-COL-LT42M", "GCDG-COL-LT45M", "GCDG-ETH")
#calculate mean of "b_tot_cog"     "b_tot_lr"      "b_tot_le"      "b_tot_mf"      "b_tot_mg"  for bayley total score. 
# add score to dscore data (and visit data for stunting)
#cut score at 70 (or 78) for bayley delay score.

b_vars <- c("b_tot_cog","b_tot_lr","b_tot_le","b_tot_mf","b_tot_mg")

b_scores <- gcdg_lean$aux %>% filter(variable %in% b_vars) %>%
  group_by(subjid)%>% summarize(b_score = mean(value, na.rm=TRUE))



sdg_by <- 
gcdg_lean$visit %>% filter(cohort %in% by3_COH) %>%
  left_join(b_scores) %>%
  left_join(model_lean$dscore) %>%
  mutate(track = ifelse(.data$daz < -2, 0, 1),
                  stunting = ifelse(.data$haz < -2, 1, 0),
         by_d = ifelse(.data$b_score < 70, 1, 0)) %>%
  group_by(ctrycd) %>%
  summarize("off-track" = 1-sum(track, na.rm=TRUE)/sum(!is.na(track)),
            "n_d" = sum(!is.na(track)),
            "stunted" = sum(stunting, na.rm=TRUE)/sum(!is.na(stunting)), 
            "n_stunt" = sum(!is.na(stunting)),
            "b_delay" = sum(by_d, na.rm = TRUE)/sum(!is.na(by_d))) %>%
  pivot_longer(cols = c("off-track", "stunted"), names_to = "Measure", values_to = "Percentage")


ggplot(data = sdg_stunt, aes(x = ctrycd, y = Percentage, fill = Measure)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  xlab("Country")
```